---
layout: post
title: "ODPS权威指南学习笔记（一）之ODPS概述"
date: 2019-03-26
excerpt: "十六说：最近换了工作，公司用的是ODPS，所以就阅读了ODPS这本书，做了一些抄录，本书讲的不算很深，但是入门可以还是可以看看的。"
tags: ODPS
feature: "https://user-images.githubusercontent.com/45778381/55421187-45c7c780-55ab-11e9-922d-ce698c67094c.png"
comments: true
---
# ODPS概述
## 1. 初识ODPS
### 1.1 什么是ODPS
&emsp;开放数据处理服务（Open Data Processing Service ，ODPS）是一个海量数据处理平台，基于阿里巴巴自主研发的分布式操作系统开发，以云计算服务的形式支撑集团数据分享和海量数据处理业务的发展。
<center><a href="http://www.aliyun.com/product/dops/"><b>阿里云官网传送门</b></a></center>

&emsp;ODPS提供PB级别的数据处理能力，适用于海量数据存储、数据仓库构建、数据统计和挖掘、机器学习和商业智能领域。
### 1.2 ODPS是什么
&emsp;ODPS是面向大数据处理的云计算服务，主要提供结构化和半结构化数据的存储和计算服务，是阿里巴巴计算整体解决方案中最核心的主力产品之一。

&emsp;和阿里云的其他云计算服务一样，ODPS也是采用HTTP的RESTful Service，客户端提供Java SDK和命令行工具（Command Line Tool，CLT），阿里云官网为用户提供统一的管理控制台界面。用户也可以使用一些集成开发环境如Eclipse和RStudio作为应用开发环境。在阿里内部，有多个团队基于ODPS构建交互界面的Web集成开发环境，提供数据采集、加工、处理分析、运营和维护的一条龙服务，线上很多作业就是运行在这些环境上的。

### 1.3 ODPS做什么
&emsp;从产品角度，ODPS主要面向三类大数据处理场景。
- 基于SQL构建大规模数据仓库和企业BI系统。
- 基于DAG（类似MapReduce编程模型）和Graph等分布式编程模型开发大数据应用。
- 基于统计和机器学习算法开发大数据统计模型和数据挖掘。

&emsp;从服务角度，ODPS采用抽象的作业处理框架将不同场景的各种计算任务统一在同一个平台之上，共享安全、存储、数据管理和资源调度，为来自不同用户需求的各种数据处理任务提供统一的编程接口和页面。

&emsp;从数据通道角度，ODPS提供了高效的数据传输服务（Tunnel），致力于实现大吞吐，支持海量数据的上传和下载。

&emsp;从功能角度，ODPS的特性包括：提供简单易用的数据上传下载工具dship；支持高度兼容标准语法的SQL处理、丰富的内建函数、自定义函数等高级功能；支持扩展的MapReduce编程框架；内置了丰富的机器学习算法如SVD、排序分位、逻辑回归和随机森林模型等。十大数据挖掘预测的利器；支持图编程模型、流式计算模型等。

&emsp;从安全角度，采用多租户协同机制，实现数据授权和共享。

&emsp;从运维角度，提供控制台Web界面管理和操作，实时监控报警。

## 2.基本概念
- 账号（Account）：表示你是谁。
- 项目空间（Project）：为了实现数据存储和计算的独立性。
- 表（Table）：划分粒度。
- 分区（Partition）：划分粒度。
- 所有者（Owner）：划分用户权限。
- 管理员（Admin）：划分用户权限。
- 普通用户（User）；划分用户权限。
- 作业（Job）：为了执行某些计算。
- 作业实例（Instance）：作业开始运行时就有了一个作业实例。
- ODPS资源（Resource）：用户实现MapReduce程序，希望提交到服务端运行时，需要把程序上传到ODPS上，相当于创建了一个ODPS资源。

### 2.1 账号（Account）
&emsp;账号可以在阿里云官网（http://www.aliyun.com）上申请注册，购买开通ODPS服务后，系统会分配密钥：AccessID和AccessKey，加密对可以确保用户的数据和计算安全。

&emsp;Alice发送请求时，会先计算AccessKey的签名，在请求中包含AccessID和签名，ODPS服务端接收到请求后，会从云账号服务获取AccessID，并对AccessKey计算签名，如果计算的签名和用户请求发送的签名一致，则认证成功。

![Snipaste_2019-04-01_16-27-24](https://user-images.githubusercontent.com/45778381/55419965-807c3080-55a8-11e9-89a1-e73c050a9ec0.png)

### 2.2 项目空间（Project）
&emsp;项目空间（Project，也称项目）是ODPS的逻辑组织单元，类似于传统数据库的Database，是进行多租户隔离和访问控制的主要边界。对于用户而言，项目空间就像一个独立的数据库系统。

### 2.3 表（Table）
&emsp;表（Table）是ODPS的数据存储单元，类似于关系数据库中的表。它在逻辑上也是由行和列组成的二维结构，每行代表一条记录，每列表示一种属性，拥有相同数据类型和名称的一个字段；一条记录可以包含一个或多列，各个列的名称和类型构成这张表的表模式。
&emsp;和在集群上搭建的数仓一样，表名命名要规范

### 2.4 分区（Partition）
&emsp;分区（Partiton）是指在一张表下，根据分区字段（一个或多个组合）对数据存储进行划分。也就是说，如果表没有分区，数据是直接放到表所在的目录下；而如果表有分区，每个分区对应表下的一个目录，数据是分别存储在不同的分区目录下。

&emsp;如果分区字段为两个组合，二级分区是一级分区的更细粒度的划分。应该结合具体业务进行一级分区和二级分区的划分。

### 2.5 任务（Task）、作业（Job）和作业实例（Instance）
- 单个SQL Query、命令和MapReduce程序统称为一个任务（Task）。
- 一个作业可以包含一个或多个Task，以及表示其执行关系的工作流（Workflow）。
- 工作流是个DAG图，描述了Job中各个Task之间的依赖关系和运行约束。
- 每个作业对应一个DAG图，其每个Task对应DAG图的一个节点。
- 实质上，作业是一个静态概念，一个作业对象即一个XML格式的文本文件。
- 当作业被提交到系统开始执行时，改作业就拥有一个作业实例（Instance）。
- 和Job相反，Instance是个动态概念，每个Instance只能运行一次。一个Job多次运行就对应多个不同的Instance。Instance保存了Job在执行时的快照（snapshot）、返回状态等信息。

### 2.6 资源（Resource）
&emsp;资源（Resource）是ODPS特有的概念，用户可以上传本地自定义的JAR包或文件作为资源，也可以将Project下的某张表作为资源。
&emsp;例如：要在集群上运行MapReduce程序，需要把MapReduce生成的Jar包上传到ODPS服务器；通过Java实现自定义函数（UDF），要在SQL查询中调用它，也需要把Java代码打包上传到ODPS服务器。此外，还可以把某个文件或ODPS表作为资源，在MapReduce计算是把资源拷贝到各个Worker上，提高执行效率。
&emsp;资源的最大好处在于给用户使用带来便捷。资源上传一次就可以一直使用，而不用每次使用前都必须执行上传。ODPS服务端不但保存了资源本身的数据内容，还包含器描述信息（Meta），后续可以对它执行更新，删除操作。

## 3. 应用开发模式
&emsp;ODPS以RESTful API方式对外提供服务，用户可以通过不同的方式来使用ODPS的服务：直接通过RESTful API请求访问、ODPS SDK、ODPS CLI（Command Line Tool）和Java集成开发环境（如Eclipse）、管理控制台、R语言集成开发环境（如Rstudio）

![Snipaste_2019-04-01_16-21-46](https://user-images.githubusercontent.com/45778381/55420036-a86b9400-55a8-11e9-9ef7-317308bfe00c.png)

### 3.1 RESTful API
&emsp;ODPS服务是以RESTful API的形式对外提供，所有的客户端组件（SDK、CLT）等都是构建在改API的语义之上。理解ODPS RESTful API，能帮助你理解ODPS服务。下面简单的描述了RESTful的核心思想。

```
什么是REST？什么是RESTful？
    REST（REpresentation State Transfer ， 表述性状态转移），是Roy Fielding博士在其2000年的博士论文中提出来的一种软件架构（或称设计原则）。REST定义了一组体系架构原则，满足这些原则的应用或设计就是RESTful。
REST原则
    REST从资源的角度来观察整个网络。资源可以理解成是一个HTTP对象（即网络上的一个实体），比如某个图片、网页，这些资源是由URI唯一确定，客户端应用通过URI获取资源的表现形式。REST定义了一组体系架构原则，可以根据这些原则设计以资源为中心的Web服务，以及使用各种客户端如何通过HTTP处理和传输资源状态。近年来，REST已经成为最重要的Web服务设计模型，对Web影响非常大。
    RESR主要原则包含以下几点：
    * 通过URI标识一个资源
    * 资源必须是可寻址的
    * 使用标准方法（GET HEAD PUT DELETE POST）
    * GET获取资源
    * PUT向一个已有URI发送HTTP POST，则是创建一个新资源。
    * DELETE删除资源
    * HEAD和GET方法类似，但不返回响应体。REST遵循CRUD原则，所有需求都可以通过这4个基本操作组合来满足。
    GET操作满足安全性。即不管执行多少次，资源状态不会发生改变。
    GET、PUT、DELETE操作满足幂等性。即不管执行多少次，结果都一样。
    POST操作不满足幂等性。很多人对PUT操作和POST操作的区别感到困惑，是否满足幂等性是其中一个非常重要的区别。如：加入要发表一篇博客，应该用PUT方法还是POST方法呢。这取决于你的服务器端定义行为：当发送两次请求时，是生成两篇日志，还是后一个覆盖前一个，如果是前一种情况，则应该使用POST方法，否则用PUT方法。
    无状态通信：无状态通信是指客户端和服务器之间的交互是无状态的，当客户端向服务器发起一个HTTP请求时，该请求必选包含服务器完成该请求所需要的全部信息。服务器不维护任何单次请求以外的客户端通信状态（但这并不代表资源没有状态）。无状态通信这一特征是的客户端的请求可以由任意一个可用的服务器来响应，这一点非常适合云计算场景。试想一下，如果是有状态通信，下一个请求必须依赖前一个请求，这就意味着该请求需要由特定的服务器才能处理，这会带来很大的局限性
```

&emsp;ODPS RESTful API设计主要遵循以下三个原则：
* 合理抽象产品中的各个对象，API设计以资源为中心开展。
* 考虑API用户场景，从用户场景出发设计API功能。
* 可以针对用户场景编写示例代码，验证API设计的可行性和易用性。

&emsp;在ODPS RESTful API中，对象被抽象成以下几种“资源”（这里的“资源”表示REST协议的资源概念，而不是ODPS的资源概念）
* 产品信息（Version），也称版本号;
* 用户空间（Project）;
* 表（Table）;
* 作业（Job）;
* 作业实例（Instance）;
* 资源（Resource）;
* 注册信息（Registration）;
* 权限管理（Privilege）。

### 3.2 ODPS SDK
&emsp;ODPS SDK是ODPS提供的访问ODPS服务的一种客户端，目前提供Java版本的事项，这主要是出于跨平台考虑。
&emsp;ODPS SDK是对ODPS RESTful API的封装，但并非一一映射关系，而是提供了更高层次的抽象，以便于用户理解并更好地使用ODPS服务。

### 3.3 ODPS CLT
&emsp;ODPS CLT(Command Line Tool)叫做Console，新版本叫做ODPS CLI（Command Line Interface），是ODPS官方提供的命令行模式的客户端工具，通过CLT可以很方便的执行各种命令。

### 3.4 管理控制台
&emsp;<a href=http://www.aliyun.com/><b>阿里云官网</b></a>提供了管理控制台

### 3.5 IDE
&emsp;用户可以基于自己熟悉的IDE来开发。

## 4.一些典型场景
&emsp;目前，ODPS平台支撑着阿里巴巴的很多业务系统，包括数据仓库、BI分析和决策支撑、信用评估和无担保贷款风险控制、广告业务、每天几十亿流量的搜索和推荐相关性分析等。

### 4.1 阿里金融数据仓库
&emsp;阿里金融数据仓库团队基于ODPS构建了一个完善复杂、功能强大的数据仓库体系，包含六个层次：
* 源数据层：处理各个来源数据，包括填报、支付宝、B2B、外部数据等。
* ODS层：作为数据导入的临时存储层。
* 企业数据仓库层：企业数据仓库采用3NF建模方式，按主题进行划分，包括完整的历史数据。
* 通用维度模型层：以维度建模方式构建面向通用业务应用的模型层，不以满足特定的应用为目的，而是屏蔽业务需求变化，以一致性维度和事实的方式为上层提供数据。
* 应用集市层：面向需求，构建满足某一应用需求的数据集市。
* 展现层：供一些数据门户（Portal）和服务等，供应用访问。
&emsp;阿里金融的数据仓库主要是基于ODPS SQL完成离线计算，并通过一系列指标规则和算法完成离线决策，输出结果给在线决策使用。

### 4.2 CNZZ数据仓库
&emsp;CNZZ是互联网数据统计分析商。它基于ODPS构建了功能强大的数据仓库，实现数据统计和挖掘。其数据仓库主要包括三层：
* ODS层：存储采集的数据，按源头业务系统的数据进行划分的原始数据存储。
* 数据仓库层（DW层）：面向主题需求，根据数据和需求双向驱动，通过ETL从ODS层抽取转换，分离为事实表和维度表。
* 集市层（Mart层）：基于DW层，面向特定产品需求，比如计算关于“人”这一主题按地域分析、按行业分布的网民统计分析，从各种不同角度进行统计分析。

### 4.3支付宝账号影响力圈
&emsp;支付宝的数据分析师想通过付款关系等信息，绘制账号影响力圈，确定账号的关键程度。付款关系图可以表示为有向图，账号即节点。很自然地，这个问题可以抽象为图计算，采用ODPS图编程模型，确定节点和变，可以很容易实现，最后可以计算出各个节点的权重，即关键程度。实际上，这个问题和使用经典的PageRank算法计算网页权重如出一辙。
